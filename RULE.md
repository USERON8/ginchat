# ginchat 实时通讯项目开发规范

## 一、规范说明

本文档为 `ginchat` 实时通讯IM项目的统一开发规范，适用于项目所有Go代码、数据库设计、接口开发、工程配置等全流程开发环节。

制定本规范的核心目的是：**统一代码风格、降低维护成本、规避线上故障、提升协作效率、保障高并发场景下的服务稳定性**。

所有参与项目开发的人员必须严格遵守本规范，新增功能/修改代码前必须先熟悉本规范。

---

## 二、项目结构规范

项目采用**分层架构**，目录职责单一清晰，禁止跨目录乱放文件、禁止职责越界。

当前固定目录结构及职责如下：

```Plain Text

ginchat/
├── api/          # 接口层：仅存放接口Handler处理函数，不包含任何业务逻辑和数据库操作
│   └── xxx_api.go # 按模块划分文件，如user_api.go、message_api.go
├── config/       # 配置目录：仅存放yaml配置文件，禁止存放代码
│   └── config.yaml
├── dao/          # 数据访问层：所有数据库读写操作收口在此，禁止其他层直接操作DB
│   └── xxx_dao.go
├── global/       # 全局层：仅存放全局单例、初始化函数，禁止存放业务逻辑
│   ├── global.go # 全局变量定义
│   ├── config.go # Viper配置初始化与绑定
│   ├── db.go     # GORM数据库初始化
│   ├── redis.go  # Redis连接初始化
│   └── logger.go # Zap日志初始化
├── models/       # 模型层：仅存放数据库表对应的结构体、枚举定义，禁止存放业务逻辑
│   └── xxx.go
├── router/       # 路由层：仅存放路由注册、中间件绑定，禁止存放业务逻辑
│   └── router.go
├── service/      # 业务层：核心业务逻辑收口在此，仅被api层调用，调用dao层完成数据操作
├── websocket/    # 长连接层：IM核心WebSocket连接管理、消息分发、心跳保活逻辑
├── utils/        # 工具层：通用无状态工具函数，如加密、脱敏、校验、响应封装等
├── test/         # 测试目录：单元测试、压力测试代码
├── go.mod        # 项目依赖管理
└── main.go       # 项目启动入口：仅做初始化顺序控制、服务启动，无业务逻辑
```

### 目录访问约束

- 禁止反向调用：`dao层` 不能调用 `service层`，`service层` 不能调用 `api层`

- 禁止越界操作：`api层` 禁止直接操作DB/Redis，必须通过 `service层`/`dao层` 操作

- 禁止职责混乱：工具函数必须放在 `utils`，禁止在业务代码里硬编码通用逻辑

---

## 三、命名规范（核心强制规范）

### 3.1 通用原则

- 所有命名必须**见名知意**，禁止使用拼音、无意义缩写、单字符变量（循环变量i/j除外）

- 严格区分：**Go代码层全驼峰命名，数据库层全下划线(蛇形)命名**，无任何例外

### 3.2 包命名规范

- 全小写字母，禁止使用驼峰、下划线、中划线

- 简短且唯一，不与标准库重名，禁止使用复数

- 示例：`models`、`dao`、`api`、`utils`，禁止 `userModels`、`dao_layer`

### 3.3 文件命名规范

- 全小写字母，下划线分隔单词，禁止使用驼峰

- 按模块/功能命名，禁止无意义文件名

- 示例：`user_basic.go`、`user_api.go`、`dao_basic.go`，禁止 `UserApi.go`、`userapi.go`

### 3.4 结构体/接口命名规范

- 大驼峰（PascalCase）命名，首字母必须大写（保证可导出）

- 结构体名与表名对应，示例：`UserBasic` 对应表 `user_basic`

- 接口名以 `er` 为后缀，单一职责，示例：`UserHandler`、`MessageSender`

- 禁止结构体嵌套过深，禁止匿名结构体滥用

### 3.5 函数/方法命名规范

- 对外暴露的函数/方法：大驼峰命名，首字母大写

- 包内私有函数/方法：小驼峰命名，首字母小写

- 命名必须体现函数职责，动词+名词格式，示例：`GetUserByID`、`CreateMessage`、`encryptPassword`

- 布尔返回值的函数，建议以 `Is/Has/Can` 为前缀，示例：`IsUserOnline`、`HasPermission`

### 3.6 常量/变量命名规范

- 常量：全大写下划线分隔，示例：`MAX_LOGIN_COUNT`、`TOKEN_EXPIRE_SECOND`

- 变量：小驼峰命名，示例：`userInfo`、`onlineUserCount`

- 布尔变量：以 `Is/Has/Can` 为前缀，示例：`IsLoggedIn`、`IsAdmin`（与现有UserBasic字段对齐）

- 禁止全局变量滥用，除global包外，其他包禁止定义全局变量

### 3.7 数据库命名规范（强制遵守）

#### 表命名

- 全小写字母，下划线分隔单词，单数形式，禁止复数

- 显式通过 `TableName()` 方法指定表名，禁止依赖GORM自动生成复数表名

- 示例：`user_basic`、`message_record`、`group_info`，禁止 `userBasics`、`user_basics`

#### 字段命名

- 全小写字母，下划线分隔单词，禁止驼峰

- 必须通过 `gorm:"column:xx_xx"` 显式绑定字段名，无任何例外

- 主键统一为 `id`，外键统一为 `xxx_id`，示例：`user_id`、`group_id`

- 时间字段统一格式：`xxx_time`/`xxx_at`，示例：`login_time`、`created_at`

- 示例：

    ```Go
    
    // 正确：Go代码驼峰，数据库字段下划线显式绑定
    Username  string `gorm:"column:username;type:varchar(32);not null;comment:用户登录名"`
    PassWord  string `gorm:"column:pass_word;type:varchar(128);not null;comment:加密密码"`
    LoginTime uint64 `gorm:"column:login_time;type:bigint unsigned;comment:最新登录时间戳"`
    ```

---

## 四、代码编写规范

### 4.1 代码格式化

- 所有代码必须通过 `gofmt`/`goimports` 格式化，IDE必须开启「保存自动格式化」

- 禁止手动调整代码缩进、换行，统一使用4空格缩进，禁止Tab

- 代码块之间空行不超过1行，禁止连续空行

### 4.2 包导入规范

- 导入分块，块之间空行分隔，顺序固定为：`标准库 -> 第三方库 -> 项目内部包`

- 禁止使用相对路径导入，所有内部包导入基于go.mod的模块名

- 示例：

    ```Go
    
    // 正确导入格式
    import (
        // 1. 标准库
        "context"
        "fmt"
    
        // 2. 第三方库
        "github.com/gin-gonic/gin"
        "gorm.io/gorm"
        "go.uber.org/zap"
    
        // 3. 项目内部包
        "ginchat/global"
        "ginchat/models"
        "ginchat/utils"
    )
    ```

### 4.3 错误处理规范

- 必须处理所有error，禁止使用 `_` 忽略错误（明确不需要处理的场景除外）

- 错误必须携带上下文信息，使用 `fmt.Errorf("xxx失败: %w", err)` 包装，禁止裸返回错误

- 禁止在循环内panic，业务错误必须通过error返回，仅在项目初始化失败时可panic

- 接口层的错误必须统一通过响应体返回，禁止直接panic到客户端

### 4.4 函数/方法规范

- 单一职责原则：一个函数仅做一件事，函数体长度建议不超过80行

- 参数数量不超过5个，超过5个必须使用结构体传参

- 返回值顺序固定：`结果值 -> error`，示例：`func GetUserByID(id uint) (*models.UserBasic, error)`

- 所有对外导出的函数/方法，必须添加注释说明用途、参数、返回值

### 4.5 注释规范

- 包注释：每个包必须添加包注释，说明包的用途

- 导出元素注释：所有首字母大写的结构体、函数、方法、常量，必须添加注释

- 注释使用中文，简洁清晰，禁止废话注释（如 `// 获取用户信息 函数用于获取用户信息`）

- 复杂业务逻辑必须添加行内注释，说明逻辑意图

- 禁止注释掉的代码提交到仓库，无用代码直接删除

---

## 五、数据库与ORM规范

### 5.1 模型定义规范

- 所有表模型必须放在 `models` 目录，一个表对应一个go文件

- 必须显式定义 `TableName()` 方法，禁止GORM自动生成表名

- 所有字段必须添加 `gorm` 标签，显式指定 `column`、`type`、`约束`、`comment`，禁止省略

- 必须使用软删除，优先继承 `gorm.Model`（自带ID、创建/更新/删除时间、软删除）

- 禁止在模型结构体中添加业务方法，模型仅做数据载体

### 5.2 数据库操作规范

- 所有数据库操作必须收口在 `dao` 层，禁止在api/service层直接调用 `global.DB`

- 通用CRUD通过泛型DAO封装，复杂查询在对应模块的DAO中实现

- 所有DB操作必须通过 `WithContext(ctx)` 传递上下文，用于超时控制、链路追踪

- 禁止字符串拼接SQL，必须使用GORM参数绑定，防止SQL注入

- 批量操作必须控制批次大小，禁止一次性操作上万条数据

- 禁止使用 `Select *`，必须指定查询字段，减少数据传输

### 5.3 索引规范

- 查询频繁的字段必须添加索引，唯一字段必须添加唯一索引（如username、phone、email）

- 联合索引必须符合最左前缀原则，区分度高的字段放在前面

- 禁止过度索引，索引数量单表不超过6个，禁止在低区分度字段上建索引

- 所有索引必须添加注释，说明索引用途

### 5.4 迁移规范

- 表结构变更必须通过GORM的 `AutoMigrate` 实现，禁止手动修改线上表结构

- 新增字段必须设置默认值，禁止新增NOT NULL无默认值的字段

- 禁止物理删除数据，所有删除操作必须使用软删除

- 表结构变更必须在测试环境验证通过后，再同步到线上环境

---

## 六、接口与路由规范

### 6.1 路由规范

- 所有路由必须在 `router` 目录统一注册，按业务模块分组

- 路由路径全小写，下划线分隔单词，采用RESTful风格：

    - GET：查询数据

    - POST：新增数据

    - PUT：修改数据

    - DELETE：删除数据

- 接口必须加版本前缀，示例：`/api/v1/user/info`、`/api/v1/message/send`

- 中间件必须按组绑定，鉴权中间件禁止全局绑定，避免公开接口被拦截

### 6.2 接口响应规范

- 所有接口必须使用统一的响应格式，禁止自定义返回结构

- 统一响应体格式（utils/response.go）：

    ```Go
    
    type Response struct {
        Code int         `json:"code"` // 状态码：200成功，400业务错误，500系统错误
        Msg  string      `json:"msg"`  // 提示信息
        Data interface{} `json:"data"` // 响应数据
    }
    ```

- 成功响应必须返回对应数据，无数据时返回 `{}`，禁止返回null

- 错误响应必须返回清晰的提示信息，禁止返回原始错误信息给客户端

### 6.3 入参校验规范

- 所有接口入参必须定义结构体，禁止使用 `map[string]interface{}` 接收参数

- 入参必须通过 `binding` 标签添加校验规则，示例：`binding:"required,email"`

- 必须在接口入口完成入参校验，校验不通过直接返回，禁止非法参数进入业务逻辑

- 入参必须做长度、格式、范围校验，防止恶意参数导致服务异常

---

## 七、全局组件规范

### 7.1 配置管理规范

- 所有可配置项必须放在 `config/config.yaml`，禁止在代码中硬编码配置

- 配置项必须在 `global/config.go` 中定义对应的结构体，禁止直接使用 `viper.Get()` 读取配置

- 敏感配置（数据库密码、密钥等）禁止提交到代码仓库，必须通过环境变量注入

- 配置按模块分组，禁止平铺配置项

### 7.2 日志规范

- 必须使用全局的 `global.Log` 打印日志，禁止使用 `fmt.Println`/`log` 标准库打印

- 日志分级使用：

    - Debug：开发调试信息，上线后关闭

    - Info：核心流程记录，如用户登录、服务启动

    - Warn：异常但不影响业务的情况，如重试、参数非法

    - Error：业务/系统错误，必须携带error和上下文信息

    - Fatal：服务启动失败，仅在main函数中使用

- 禁止打印敏感信息：密码、Token、用户手机号/邮箱明文、密钥等

- 错误日志必须携带完整上下文，如用户ID、请求ID、错误链路

### 7.3 Redis规范

- 必须使用全局的 `global.RDB` 操作Redis，禁止重复创建连接

- Key命名规范：`业务前缀:模块:功能:唯一标识`，示例：`im:user:online:1`、`im:limit:login:138xxxx1234`

- 所有Key必须设置过期时间，禁止创建永久Key

- 禁止使用大Key、热Key，单Key值大小不超过10KB

- 禁止在循环中执行Redis命令，批量操作必须用pipeline

- 所有Redis操作必须传递上下文，用于超时控制

---

## 八、IM长连接专属规范

### 8.1 WebSocket连接管理

- 长连接逻辑统一放在 `websocket` 目录，禁止分散在其他模块

- 每个连接必须绑定用户ID，在线状态同步到Redis，与 `user_basic` 表的 `IsLoggedIn`、`HeartbeatTime` 字段联动

- 必须实现连接池管理，限制单用户最大连接数，防止恶意连接耗尽服务资源

- 连接断开必须清理资源，更新用户在线状态，避免内存泄漏

### 8.2 消息规范

- WebSocket消息必须定义统一的结构体，固定消息类型、发送方、接收方、内容、时间戳

- 必须实现心跳保活机制，客户端定时发送心跳包，服务端更新心跳时间，超时自动断开连接

- 消息必须实现可靠投递，离线消息入库，用户上线后自动推送，禁止消息丢失

- 群聊/广播消息必须通过MQ削峰，禁止同步推送，防止高并发下服务雪崩

---

## 九、安全规范

### 9.1 账号与密码安全

- 用户密码必须使用bcrypt不可逆加密存储，禁止明文、可逆加密存储

- 接口返回、日志打印中，必须完全移除密码字段，哪怕是加密后的密文

- 登录接口必须加限流、防暴力破解机制，多次失败锁定账号

- 必须实现Token鉴权机制，所有非公开接口必须校验Token，禁止未授权访问

### 9.2 数据安全

- 手机号、邮箱等敏感信息，在接口返回、日志打印中必须脱敏处理

- 必须防SQL注入：禁止字符串拼接SQL，所有查询必须使用参数绑定

- 必须防XSS攻击：用户输入内容必须过滤特殊字符，禁止直接渲染到前端

- 必须防CSRF攻击：跨域请求必须做严格校验，禁止开放全量跨域

---

## 十、Git提交规范

### 10.1 分支规范

- `main`：生产环境分支，禁止直接提交，仅通过合并dev分支更新

- `dev`：开发环境分支，所有功能开发完成后合并到此

- `feature/xxx`：功能开发分支，从dev分支创建，开发完成后合并回dev

- `bugfix/xxx`：bug修复分支，从dev分支创建，修复完成后合并回dev

### 10.2 提交信息规范

- 提交信息格式：`<type>(<scope>): <subject>`

- type类型固定为：

    - `feat`：新增功能

    - `fix`：修复bug

    - `docs`：文档更新

    - `style`：代码格式调整，不影响逻辑

    - `refactor`：代码重构，不新增功能、不修复bug

    - `test`：测试相关

    - `chore`：工程配置、依赖管理等

- 示例：

    - `feat(user): 实现用户注册与登录接口`

    - `fix(message): 修复离线消息推送丢失问题`

    - `docs: 更新开发规范文档`

---

## 十一、附则

1. 本规范自发布之日起执行，所有项目开发人员必须严格遵守

2. 本规范未尽事宜，遵循Go官方编码规范、Gin/GORM官方最佳实践

3. 随着项目迭代，可根据实际需求补充、更新本规范

4. 代码提交前必须自检是否符合本规范，不符合规范的代码禁止合并到dev分支
> （注：文档部分内容可能由 AI 生成）